const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vapi-Bv3KIZrq.js","assets/index-CFiATYwG.js","assets/index-DlfDqjau.css","assets/call-details-CUxIrFUN.js","assets/card-DS2EmXxJ.js","assets/use-vapi-calls-xcMCoUwq.js","assets/translations-ArtDJxZd.js","assets/badge-CpQE5GvW.js","assets/dialog-BDiuGZoT.js","assets/index-CvvBGb42.js","assets/index-TAiPsSzF.js","assets/index-C8CTvvEi.js","assets/index-DCrN6bWT.js","assets/index-Cu-SaQdC.js","assets/x-Ch_J6GrT.js","assets/scroll-area-B7KhP4eU.js","assets/index-BdQq_4o_.js","assets/sign-out-dialog-CdNQkXpx.js","assets/index-DjUhfK-E.js","assets/index-BcNlsQiw.js","assets/index-BdDfE_wo.js","assets/index-CzXaU_pf.js","assets/index-DDx4xDs4.js","assets/check-BepUPVCN.js","assets/chevron-right-pit72iVT.js","assets/satisfaction-score-412dYo8w.js","assets/loader-circle-B9jCdxw7.js","assets/eye-DjOQmGIR.js","assets/message-square-D2s3tWK0.js","assets/profile-dropdown-DuHLF1hN.js","assets/sun-DWz8-CTQ.js","assets/main-B5oOq8Nj.js","assets/language-selector-OYNQShOL.js","assets/menu-7sfJY0Es.js","assets/zap-gA41c9Qf.js","assets/phone-Bldwagvz.js","assets/business-setup-B80a5wPe.js","assets/label-CH8Q-0XS.js","assets/alert-RPvsmR1D.js","assets/mail-Ba7dxHPf.js","assets/call-timeline-graph-fIu9KXuv.js","assets/wrench-Cl0DIT8w.js","assets/user-plus-Bz9G2Amm.js","assets/format-Dp3w_Y3x.js"])))=>i.map(i=>d[i]);
import{c as J,s as x,a as I,r as h,f as H,j as e,B as v,t as y,_ as R}from"./index-CFiATYwG.js";import{g as S,u as M,a as Y}from"./translations-ArtDJxZd.js";import{H as L,T as F,P as D}from"./profile-dropdown-DuHLF1hN.js";import{M as q}from"./main-B5oOq8Nj.js";import{u as K,T as B,P as O,L as z}from"./language-selector-OYNQShOL.js";import{B as E}from"./badge-CpQE5GvW.js";import{S as Z}from"./scroll-area-B7KhP4eU.js";import{C as j,b as w,c as N,a as b}from"./card-DS2EmXxJ.js";import{P as C}from"./phone-Bldwagvz.js";import{X as T}from"./x-Ch_J6GrT.js";import{z as g}from"./sign-out-dialog-CdNQkXpx.js";import{Z as X,C as Q}from"./zap-gA41c9Qf.js";import{B as ee}from"./business-setup-B80a5wPe.js";const te=[["path",{d:"M14 6h8",key:"yd68k4"}],["path",{d:"m18 2 4 4-4 4",key:"pucp1d"}],["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],se=J("phone-forwarded",te);const re=[["path",{d:"M10.1 13.9a14 14 0 0 0 3.732 2.668 1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2 18 18 0 0 1-12.728-5.272",key:"1wngk7"}],["path",{d:"M22 2 2 22",key:"y4kqgn"}],["path",{d:"M4.76 13.582A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 .244.473",key:"10hv5p"}]],ae=J("phone-off",re);async function ne(a){try{const{data:{session:r}}=await x.auth.getSession(),s=I.getState().auth,o=s.user&&s.session;if(!r&&!o)return console.log("No Supabase Auth session found. Skipping customer sync (custom auth users already have customer records)."),null;if(o&&!r)return console.log("Custom auth session detected. Skipping customer sync (customer record already exists)."),null;const{data:n,error:c}=await x.from("customers").select("*").eq("email",a.email).maybeSingle();if(c&&c.code!=="PGRST116")throw c;if(n){const{data:d,error:m}=await x.from("customers").update({first_name:a.first_name,last_name:a.last_name,phone:a.phone,title:a.title,updated_at:new Date().toISOString()}).eq("id",n.id).select().single();if(m)throw m;return d}else{const d={email:a.email,first_name:a.first_name,last_name:a.last_name,phone:a.phone,title:a.title},m="your-default-company-id",{data:u,error:i}=await x.from("customers").insert(d).select().single();if(i)throw i;return u}}catch(r){throw console.error("Error creating/updating customer:",r),r}}function le(){const{user:a,session:r}=I(s=>s.auth);h.useEffect(()=>{if(!a)return;const s=setTimeout(()=>{(async()=>{try{const{data:{session:n}}=await x.auth.getSession();if(!n&&r){console.log("Custom auth session detected. Skipping customer sync.");return}const c=a.email,d=a.user_metadata||{};if(!c){console.error("No email found in user session");return}const m=d.full_name||d.name||"",u=d.first_name||(m?m.split(" ")[0]:null)||null,i=d.last_name||(m?m.split(" ").slice(1).join(" "):null)||null;await ne({email:c,first_name:u||void 0,last_name:i||void 0,phone:d.phone||void 0,title:d.title||void 0})&&console.log("Customer record synced successfully")}catch(n){n instanceof Error&&!n.message.includes("Skipping")&&console.error("Failed to sync customer record:",n)}})()},2e3);return()=>clearTimeout(s)},[a,r])}const $=H()(a=>({notifications:[],currentNotification:null,setCurrentNotification:r=>a({currentNotification:r}),clearCurrentNotification:()=>a({currentNotification:null}),addNotification:r=>{const s=S();if(!s){console.warn("Cannot add notification: no customer ID found");return}if(r.customer_id!==s){console.warn("Ignoring notification from different customer:",{notificationCustomerId:r.customer_id,currentCustomerId:s});return}a(o=>o.notifications.some(c=>c.id===r.id)?(console.log("Notification already exists, skipping:",r.id),o):{notifications:[...o.notifications,r]})},removeNotification:r=>a(s=>({notifications:s.notifications.filter(o=>o.id!==r)})),clearAllNotifications:()=>a(()=>({notifications:[]}))}));function oe(){const{addNotification:a}=$(),r=h.useRef(null),s=h.useRef(null);h.useEffect(()=>{const o=S();s.current=o},[]),h.useEffect(()=>{const o=setTimeout(()=>{const n=s.current;if(!n)return;const c=x.channel(`webhook-listener-${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"user_events",filter:`customer_id=eq.${n}`},d=>{const m=d.new;m.customer_id===n&&a(m)}).subscribe();r.current=c},1e3);return()=>{clearTimeout(o),r.current&&(x.removeChannel(r.current),r.current=null)}},[a])}function ce({content:a,className:r=""}){if(!a)return null;const s=n=>{if(!n)return[];const c=[];let d=0,m=0;const u=[];let i;const l=/\*\*(.+?)\*\*/g;for(;(i=l.exec(n))!==null;)u.push({start:i.index,end:i.index+i[0].length,content:i[1]});if(u.map(f=>({...f,type:"bold"})).sort((f,p)=>f.start-p.start).forEach(f=>{if(f.start>d){const p=n.substring(d,f.start);p&&c.push(e.jsx("span",{children:p},`text-${m++}`))}c.push(e.jsx("strong",{className:"font-semibold",children:f.content},`bold-${m++}`)),d=f.end}),d<n.length){const f=n.substring(d);f&&c.push(e.jsx("span",{children:f},`text-${m++}`))}return c.length>0?c:[e.jsx("span",{children:n},"text-0")]},o=n=>{const c=[];let d=0;return n.split(`
`).forEach(u=>{if(u.trim()===""){c.push(e.jsx("br",{},`br-${d++}`));return}const i=u.match(/^[-*]\s+(.+)$/);if(i){const t=s(i[1]);c.push(e.jsxs("div",{className:"flex items-start gap-2 my-1.5",children:[e.jsx("span",{className:"text-primary mt-1.5 flex-shrink-0",children:"â€¢"}),e.jsx("div",{className:"flex-1",children:t})]},`list-${d++}`));return}const l=s(u.trim());c.push(e.jsx("p",{className:"mb-2 last:mb-0",children:l},`p-${d++}`))}),c};return e.jsx("div",{className:`markdown-content ${r}`,children:o(a)})}function ie(){const{notifications:a,removeNotification:r,clearAllNotifications:s}=$(),o=S(),n=M(),c=a.filter(l=>l.customer_id===o),d=c.length>0,m=l=>{try{if(!l)return null;let t=l;if(typeof l=="string")try{t=JSON.parse(l)}catch{return null}if(t?.type)return String(t.type);if(Array.isArray(t)&&t.length>0){const f=t[0];if(f?.type)return String(f.type)}return t?.call_type?String(t.call_type):t?.callType?String(t.callType):t?.message?.type?String(t.message.type):t?.artifact?.type?String(t.artifact.type):t?.data?.type?String(t.data.type):null}catch(t){return console.error("Error extracting call type:",t),null}},u=l=>{try{if(!l)return n.webhook.noSummaryAvailable;if(typeof l=="string"){const f=l.trim();if(f.length>0)return f}let t=l;if(typeof l=="string")try{t=JSON.parse(l)}catch{return l.trim()}if(t?.body){if(typeof t.body=="string")return t.body.trim();if(typeof t.body=="object"){const f=t.body.summary||t.body.content||t.body.message||JSON.stringify(t.body);return String(f).trim()}}if(t?.summary)return String(t.summary);if(t?.call_summary)return String(t.call_summary);if(t?.callSummary)return String(t.callSummary);if(t?.message?.summary)return String(t.message.summary);if(t?.artifact?.summary)return String(t.artifact.summary);if(t?.data?.summary)return String(t.data.summary);if(t?.analysis?.summary)return String(t.analysis.summary);if(t?.message?.analysis?.summary)return String(t.message.analysis.summary);if(t?.message?.artifact?.messages){const f=t.message.artifact.messages;if(Array.isArray(f)&&f.length>0){const p=f[f.length-1];if(p?.message)return String(p.message);if(p?.content)return String(p.content)}}if(t?.messages&&Array.isArray(t.messages)&&t.messages.length>0){const f=t.messages[t.messages.length-1];if(f?.message)return String(f.message);if(f?.content)return String(f.content)}return t?.message?String(t.message):t?.content?String(t.content):t?.text?String(t.text):t?.action?`Action: ${t.action}`:t?.reason?`Reason: ${t.reason}`:t?.customer_request?`Customer requested: ${t.customer_request}`:n.webhook.noSummaryAvailable}catch(t){return console.error("Error extracting call summary:",t,"Payload:",l),l&&typeof l=="string"?l.trim():n.webhook.summaryExtractionError}},i=async l=>{if(!l?.call_id){y.error(n.webhook.noCallIdAvailable);return}const t=l.call_id,f=u(l.payload),p=l.call_type||m(l.payload);console.log("Notification payload structure:",{rawPayload:l.payload,payloadType:typeof l.payload,isArray:Array.isArray(l.payload),notificationCallType:l.call_type,extractedCallType:m(l.payload),finalCallType:p});const k={call_id:t,customer_id:l.customer_id,event_type:l.event_type,call_type:p,summary:f,created_at:l.created_at,payload:l.payload};console.log("Webhook body being sent:",k);try{fetch("https://n8n.goreview.fr/webhook-test/pickup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k),keepalive:!0}).catch(_=>{console.warn("Webhook-test/pickup request failed (non-blocking):",_)}),fetch("https://n8n.goreview.fr/webhook/pickup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k),keepalive:!0}).catch(_=>{console.warn("Webhook/pickup request failed (non-blocking):",_)}),y.success(n.webhook.callPickedUpSuccess),console.log("Pickup webhooks sent (fire-and-forget) for call:",t,"with data:",k)}catch(_){console.error("Error setting up pickup webhooks:",_),y.error(n.webhook.webhookError)}};return!d||c.length===0?null:e.jsx("div",{className:"fixed right-0 top-0 h-screen w-96 bg-background border-l shadow-lg z-50 flex flex-col animate-in slide-in-from-right duration-300",children:e.jsxs(j,{className:"h-full rounded-none border-0 shadow-none flex flex-col",children:[e.jsx(w,{className:"border-b flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(C,{className:"h-5 w-5 text-primary"}),n.webhook.incomingCall,c.length>1&&e.jsx(E,{variant:"secondary",className:"ml-2",children:c.length})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{variant:"secondary",className:"bg-green-100 text-green-800",children:n.webhook.new}),e.jsx(v,{variant:"ghost",size:"icon",onClick:s,className:"h-8 w-8",title:"Clear all",children:e.jsx(T,{className:"h-4 w-4"})})]})]})}),e.jsx(b,{className:"flex-1 flex flex-col overflow-hidden p-0",children:e.jsx(Z,{className:"flex-1",children:e.jsx("div",{className:"space-y-4 p-4",children:c.map((l,t)=>{const f=u(l.payload),p=t===c.length-1;return e.jsx(j,{className:p?"":"border-b-2 border-b-primary/20",children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs(E,{variant:"secondary",className:"bg-green-100 text-green-800",children:["#",t+1]}),c.length>1&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[t===0?"First":t===1?"Second":t===2?"Third":`${t+1}th`," request"]})]}),e.jsxs("div",{className:"rounded-lg bg-muted p-3",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",children:n.webhook.callSummary}),e.jsx("div",{className:"text-sm leading-relaxed",children:e.jsx(ce,{content:f})})]})]}),e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>r(l.id),className:"h-8 w-8 flex-shrink-0",title:"Dismiss",children:e.jsx(T,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-col gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[n.webhook.receivedAt," ",new Date(l.created_at).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit"})]}),l.call_id&&e.jsxs("span",{className:"font-mono text-xs bg-muted px-2 py-1 rounded break-all",children:[n.webhook.callId," ",l.call_id]})]}),e.jsxs("div",{className:"flex flex-col gap-2 pt-2 border-t",children:[e.jsxs(v,{variant:"outline",onClick:()=>r(l.id),className:"w-full",size:"sm",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),n.webhook.close]}),e.jsxs(v,{onClick:()=>i(l),className:"w-full bg-green-600 hover:bg-green-700",size:"sm",children:[e.jsx(C,{className:"h-4 w-4 mr-2"}),n.webhook.pickUpCall]})]})]})})},l.id)})})})})]})})}async function ue(a,r=50){try{const{data:s,error:o}=await x.from("call_logs").select("*").eq("customer_id",a).order("started_at",{ascending:!1,nullsFirst:!1}).order("created_at_db",{ascending:!1}).limit(r);if(o){if(o.code==="PGRST205"||o.message?.includes("call_logs"))return console.warn("call_logs table does not exist. Please run supabase-call-logs-schema.sql"),[];throw console.error("Error fetching call logs:",o),o}return s||[]}catch(s){if(s.code==="PGRST205")return console.warn("call_logs table does not exist. Please run supabase-call-logs-schema.sql"),[];throw console.error("Error getting call logs:",s),s}}let A=null;const de="3413568f-9f14-42fa-816e-41db9699f7e3";function me(a){if(a.length===0)return"No previous call logs available.";const r=[];return r.push(`You are a personalized call manager assistant. You have access to ${a.length} previous call logs from this customer's AI receptionist agents.`),r.push(`

## Previous Call Logs:
`),a.forEach((s,o)=>{const n=s.started_at?new Date(s.started_at).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"Unknown date",c=s.duration?`${Math.floor(s.duration/60)}m ${s.duration%60}s`:"Unknown duration";r.push(`
### Call ${o+1} - ${n} (Duration: ${c})`),s.summary&&r.push(`Summary: ${s.summary}`);let d="";s.transcript&&(Array.isArray(s.transcript)?d=s.transcript.map(m=>{const u=m.role||"unknown",i=m.content||m.text||"";return`${u}: ${i}`}).join(`
`):typeof s.transcript=="string"?d=s.transcript:s.transcript.content&&(d=s.transcript.content)),!d&&s.messages&&(Array.isArray(s.messages)?d=s.messages.map(m=>{const u=m.role||"unknown",i=m.content||m.text||"";return`${u}: ${i}`}).join(`
`):typeof s.messages=="string"&&(d=s.messages)),d.trim()&&r.push(`Transcript:
${d}`),s.ended_reason&&r.push(`Ended reason: ${s.ended_reason}`),r.push("---")}),r.push(`

## Instructions:`),r.push("When the user asks about a previous call, use the information above to provide accurate details."),r.push("You can reference specific calls by their date, duration, or content."),r.push("If asked about decisions made by other agents, explain them based on the call logs above."),r.push("Be helpful, concise, and accurate when referencing past calls."),r.join(`
`)}function fe(){const[a,r]=h.useState(!1),[s,o]=h.useState(!1),n=h.useRef(null),c=M(),d=async()=>{if(n.current)return n.current;try{if(!A){const i=await R(()=>import("./vapi-Bv3KIZrq.js").then(l=>l.v),__vite__mapDeps([0,1,2]));A=i.default||i}const u=Y();if(!u)throw new Error("No public API key found");return n.current=new A(u),n.current.on("call-start",()=>{console.log("[CallManagerButton] Call started"),r(!0),o(!1),y.success(c.callManager?.callStarted||"Call started!")}),n.current.on("call-end",()=>{console.log("[CallManagerButton] Call ended"),r(!1),y.info(c.callManager?.callEnded||"Call ended")}),n.current.on("error",i=>{console.error("[CallManagerButton] VAPI error:",i),r(!1),o(!1),y.error(c.callManager?.callError||"Call error occurred")}),n.current}catch(u){throw console.error("[CallManagerButton] Failed to initialize VAPI:",u),u}};h.useEffect(()=>()=>{if(n.current){try{n.current.stop()}catch(u){console.error("[CallManagerButton] Error stopping VAPI on cleanup:",u)}n.current=null}},[]);const m=async()=>{if(a)try{n.current&&(n.current.stop(),r(!1),y.info(c.callManager?.callStopped||"Call stopped"))}catch(u){console.error("[CallManagerButton] Error stopping call:",u),y.error(c.callManager?.stopError||"Failed to stop call")}else{o(!0);try{const u=S();if(!u){y.error("Customer ID not found"),o(!1);return}y.info(c.callManager?.updatingContext||"Loading your call history...");const i=await ue(u,100),l=me(i);n.current||await d(),await n.current.start(de,{variableValues:{context:l}})}catch(u){console.error("[CallManagerButton] Error starting call:",u),r(!1),o(!1),y.error(u.message||c.callManager?.startError||"Failed to start call")}}};return e.jsx(v,{onClick:m,disabled:s,className:"gap-2",variant:a?"destructive":"default",children:s?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4 animate-pulse"}),c.callManager?.connecting||"Connecting..."]}):a?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-4 w-4"}),c.callManager?.stopCall||"Stop Call"]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-4 w-4"}),c.callManager?.button||"Call Manager"]})})}const P="aurora_call_stats_cache",he=300*1e3;function pe(){try{const a=localStorage.getItem(P);if(!a)return null;const{stats:r,timestamp:s}=JSON.parse(a);return Date.now()-s<he?r:(localStorage.removeItem(P),null)}catch{return null}}function U(a){try{localStorage.setItem(P,JSON.stringify({stats:a,timestamp:Date.now()}))}catch{}}async function W(a,r=!1){if(r){const s=pe();if(s)return Promise.resolve().then(async()=>{try{await W(a,!1)}catch{}}),s}try{const{data:s,error:o}=await x.rpc("get_customer_call_stats",{customer_id_param:a});if(o){if(o.code==="42883"||o.message?.includes("function")||o.message?.includes("does not exist"))return console.warn("[calculateStatsFromCallLogs] RPC function not found, using fallback calculation. Please run supabase-stats-function.sql"),await G(a);if(o.code==="PGRST205"||o.message?.includes("call_logs"))return console.warn("[calculateStatsFromCallLogs] call_logs table not found or RLS blocking access"),{totalCalls:0,live:0,transferred:0,totalMinutes:0};throw console.error("[calculateStatsFromCallLogs] RPC error:",o),o}const n={totalCalls:s?.totalCalls||0,live:s?.live||0,transferred:s?.transferred||0,totalMinutes:s?.totalMinutes||0};return U(n),n}catch(s){return s.code==="PGRST205"?{totalCalls:0,live:0,transferred:0,totalMinutes:0}:(console.error("Error calculating stats from call_logs:",s),await G(a))}}async function G(a){try{const[r,s,o,n]=await Promise.all([x.from("call_logs").select("*",{count:"exact",head:!0}).eq("customer_id",a),x.from("call_logs").select("*",{count:"exact",head:!0}).eq("customer_id",a).in("status",["in-progress","ringing","queued"]),x.from("call_logs").select("*",{count:"exact",head:!0}).eq("customer_id",a).or("ended_reason.ilike.%forward%,ended_reason.ilike.%transfer%,ended_reason.eq.customer-transferred-call"),x.from("call_logs").select("duration").eq("customer_id",a).not("duration","is",null)]);if([r.error,s.error,o.error,n.error].some(i=>i&&(i.code==="PGRST205"||i.message?.includes("call_logs"))))return{totalCalls:0,live:0,transferred:0,totalMinutes:0};let m=0;if(n.data&&n.data.length>0){const i=n.data.slice(0,1e3).map(t=>t.duration).filter(t=>t&&typeof t=="number"&&t>0),l=i.reduce((t,f)=>t+f,0);if(n.data.length>1e3){const t=i.length>0?l/i.length:0,f=r.count||0;m=t*f/60}else m=l/60}const u={totalCalls:r.count||0,live:s.count||0,transferred:o.count||0,totalMinutes:parseFloat(m.toFixed(2))};return U(u),u}catch(r){if(r.code==="PGRST205"||r.message?.includes("call_logs"))return{totalCalls:0,live:0,transferred:0,totalMinutes:0};throw console.error("Error in fallback calculation:",r),r}}function ge(){try{const a=localStorage.getItem("aurora_call_stats_cache");if(a){const{stats:r,timestamp:s}=JSON.parse(a);if(Date.now()-s<300*1e3)return r}}catch{}return{totalCalls:0,live:0,transferred:0,totalMinutes:0}}function xe(){const{plan:a}=K(),r=M(),[s,o]=h.useState(ge),[n]=h.useState(!1);h.useEffect(()=>{(async()=>{const m=S();if(m)try{const{data:u,error:i}=await x.from("customers").select("tot_calls").eq("id",m).maybeSingle();i&&i.code!=="PGRST116"&&console.error("Error fetching total calls from customers table:",i);const l=await W(m);o({...l,totalCalls:u?.tot_calls??l.totalCalls??0})}catch(u){console.error("Error loading fresh stats:",u)}})()},[]);const c=a?{basic:300,pro:1e3,entreprise:2500}[a]:null;return n?e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[1,2,3,4].map(d=>e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(g,{className:"h-4 w-24"}),e.jsx(g,{className:"h-4 w-4 rounded"})]}),e.jsxs(b,{children:[e.jsx(g,{className:"h-8 w-20 mb-2"}),e.jsx(g,{className:"h-3 w-32"})]})]},d))}):e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:r.stats.totalCalls}),e.jsx(C,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalCalls}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.stats.allTimeCalls})]})]}),e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:r.stats.activeLive}),e.jsx(X,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.live}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.stats.currentlyInProgress})]})]}),e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:r.stats.transferred}),e.jsx(se,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.transferred}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.stats.callsTransferred})]})]}),e.jsxs(j,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(N,{className:"text-sm font-medium",children:r.stats.totalMinutes}),e.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:c?e.jsxs(e.Fragment,{children:[Math.round(s.totalMinutes).toLocaleString()," / ",c.toLocaleString()]}):Math.round(s.totalMinutes).toLocaleString()})})]})]})})}const ye=h.lazy(()=>R(()=>import("./call-details-CUxIrFUN.js"),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39])).then(a=>({default:a.CallDetails}))),je=h.lazy(()=>R(()=>import("./call-timeline-graph-fIu9KXuv.js"),__vite__mapDeps([40,1,2,4,5,6,17,12,10,11,18,9,13,14,19,20,21,22,23,24,8,15,16,25,26,35,41,42,34,28,43,29,30,31,32,33,7,36,37,38,39])).then(a=>({default:a.CallTimelineGraph})));function be(){const{user:a,loading:r}=I(i=>i.auth),s=M(),[o,n]=h.useState(!1),c=$(i=>i.notifications),d=S(),m=c.some(i=>i.customer_id===d);le(),oe(),h.useEffect(()=>{!r&&!a?n(!0):a&&n(!1)},[a,r]);const u=()=>{n(!1)};return r?e.jsx("div",{className:"flex min-h-screen items-center justify-center",children:e.jsx("div",{className:"text-lg",children:s.dashboard.loading})}):o?e.jsxs(e.Fragment,{children:[e.jsxs(L,{showSidebarTrigger:!1,children:[e.jsx(B,{links:V}),e.jsxs("div",{className:"ms-auto flex items-center space-x-4",children:[e.jsx(O,{}),e.jsx(z,{}),e.jsx(F,{}),e.jsx(D,{})]})]}),e.jsx(q,{children:e.jsx(ee,{onComplete:u})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(L,{children:[e.jsx(B,{links:V}),e.jsxs("div",{className:"ms-auto flex items-center space-x-4",children:[e.jsx(O,{}),e.jsx(z,{}),e.jsx(F,{}),e.jsx(D,{})]})]}),e.jsx(ie,{}),e.jsx(q,{className:m?"mr-96 transition-all duration-300":"transition-all duration-300",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:s.dashboard.welcomeBackName.replace("{name}",a?.user_metadata?.first_name||a?.email?.split("@")[0]||"")}),e.jsx("p",{className:"text-muted-foreground",children:s.dashboard.overview})]}),e.jsx(fe,{})]}),e.jsx(xe,{}),e.jsx(h.Suspense,{fallback:e.jsxs(j,{children:[e.jsx(w,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(g,{className:"h-5 w-5 rounded"}),e.jsx(g,{className:"h-5 w-48"})]})}),e.jsx(b,{children:e.jsx(g,{className:"h-[400px] w-full"})})]}),children:e.jsx(je,{})}),e.jsx("div",{className:"grid gap-6 lg:grid-cols-1",children:e.jsx(h.Suspense,{fallback:e.jsxs(j,{children:[e.jsx(w,{children:e.jsxs(N,{className:"flex items-center gap-2",children:[e.jsx(g,{className:"h-5 w-5 rounded"}),e.jsx(g,{className:"h-5 w-48"})]})}),e.jsx(b,{children:e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(i=>e.jsx("div",{className:"border rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(g,{className:"h-4 w-4 rounded"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(g,{className:"h-4 w-32"}),e.jsx(g,{className:"h-3 w-24"})]}),e.jsx(g,{className:"h-5 w-16 rounded-full"}),e.jsx(g,{className:"h-8 w-12 rounded"})]})},i))})})]}),children:e.jsx(ye,{})})})]})})]})}const V=[{title:"Dashboard",href:"/",isActive:!0,disabled:!1}],we=be,$e=Object.freeze(Object.defineProperty({__proto__:null,component:we},Symbol.toStringTag,{value:"Module"}));export{$e as d,ue as g};
